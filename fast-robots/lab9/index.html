<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://jack-d-long.github.io/ name=base><title>
         Lab 9
        
    </title><meta content="Lab 9" property=og:title><meta content="This is an example description" property=og:description><meta content="This is an example description" name=description><link href=/alien.png rel=icon type=image/png><link href=https://jack-d-long.github.io/fonts.css rel=stylesheet><script src=https://jack-d-long.github.io/js/codeblock.js></script><script src=https://jack-d-long.github.io/js/toc.js></script><script src=https://jack-d-long.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link href=https://jack-d-long.github.io/atom.xml rel=alternate title=jdl298 type=application/atom+xml><link href=https://jack-d-long.github.io/theme/light.css rel=stylesheet><link href=https://jack-d-long.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://jack-d-long.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://jack-d-long.github.io/main.css media=screen rel=stylesheet><script src=https://jack-d-long.github.io/js/mermaid.js></script><script src="https://jack-d-long.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://jack-d-long.github.io/>jdl298</a><div class=socials><a class=social href=https://linkedin.com/in/jacklong257 rel=me> <img alt=linkedin src=https://jack-d-long.github.io/social_icons/linkedin.svg> </a><a class=social href=https://github.com/jack-d-long/ rel=me> <img alt=github src=https://jack-d-long.github.io/social_icons/github.svg> </a></div></div><nav><a href=https://jack-d-long.github.io/fast-robots style=margin-left:.25em>/fast robots</a><a href=https://jack-d-long.github.io/projects style=margin-left:.25em>/projects</a><a href=https://jack-d-long.github.io/about style=margin-left:.25em>/about</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://jack-d-long.github.io/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://jack-d-long.github.io/feather/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://jack-d-long.github.io/feather/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><main><article><div class=title><div class=page-header>Lab 9<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2025-04-09</time></div></div><div class=toc-container><h1 class=toc-title>Table of Contents</h1><ul class=toc-list><li><a href=https://jack-d-long.github.io/fast-robots/lab9/#previous-lab-8>Previous: Lab 8</a> <ul><li><a href=https://jack-d-long.github.io/fast-robots/lab9/#lab-tasks>Lab Tasks</a></li><ul><li><a href=https://jack-d-long.github.io/fast-robots/lab9/#mapping-the-world>Mapping The World</a></ul><li><a href=https://jack-d-long.github.io/fast-robots/lab9/#collaborations>Collaborations</a></ul><li><a href=https://jack-d-long.github.io/fast-robots/lab9/#next-lab-8>Next: Lab 8</a></ul></div><section class=body><h1 id=previous-lab-8><a aria-label="Anchor link for: previous-lab-8" class=zola-anchor href=#previous-lab-8>Previous: <a href=/fast-robots/lab8>Lab 8</a></a></h1><h2 id=lab-tasks><a aria-label="Anchor link for: lab-tasks" class=zola-anchor href=#lab-tasks>Lab Tasks</a></h2><h3 id=mapping-the-world><a aria-label="Anchor link for: mapping-the-world" class=zola-anchor href=#mapping-the-world>Mapping The World</a></h3><p>I decided to implement my mapping procedure within a BLE command case, instead of using flags and mainloop checks as in previous labs. Although this did bloat my main <code>ble_arduino.ino</code> a bit more, it was worth it for ease of implementation.<p>I used the following command, which loops through a set of angle values (in my case, 0 thru 360 degrees in increments of 15) and applies PID control to reach each distance according to the map interval. I used my previous PID recording arrays and BLE data transfer commands to reduce overhead:<pre class=language-c++ data-lang=c++ style=color:#61676c;background-color:#fafafa><code class=language-c++ data-lang=c++><span>
</span><span style=color:#fa6e32>case</span><span> START_MAP</span><span style=color:#61676ccc>:
</span><span>
</span><span>    doMap </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>    success </span><span style=color:#ed9366>=</span><span> robot_cmd</span><span style=color:#ed9366>.</span><span style=color:#f29718>get_next_value</span><span>(map_interval)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if </span><span>(</span><span style=color:#ed9366>!</span><span>success) </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// start TOF ranging
</span><span>    distanceSensor1</span><span style=color:#ed9366>.</span><span style=color:#f29718>startRanging</span><span>()</span><span style=color:#61676ccc>;
</span><span>    distanceSensor2</span><span style=color:#ed9366>.</span><span style=color:#f29718>startRanging</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span>    target_orientation </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f29718>digitalWrite</span><span>(blinkPin</span><span style=color:#61676ccc>,</span><span> HIGH)</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// visual indicator
</span><span>    </span><span style=color:#fa6e32>for</span><span>(</span><span style=color:#fa6e32>int</span><span> i </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;</span><span> i</span><span style=color:#ed9366><</span><span style=color:#ff8f40>25</span><span style=color:#61676ccc>;</span><span> i</span><span style=color:#ed9366>++</span><span>){ </span><span style=color:#abb0b6;font-style:italic>// 24 steps of 15 degrees in 360 degrees
</span><span> 
</span><span>
</span><span>      start_time_map </span><span style=color:#ed9366>= </span><span style=color:#f29718>millis</span><span>()</span><span style=color:#61676ccc>;
</span><span>      </span><span style=color:#fa6e32>while</span><span>(</span><span style=color:#f29718>millis</span><span>() </span><span style=color:#ed9366>-</span><span> start_time_map </span><span style=color:#ed9366><</span><span> map_interval){  </span><span style=color:#abb0b6;font-style:italic>// approx settling time of 15 deg move
</span><span>
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// manually record TOF
</span><span>        </span><span style=color:#fa6e32>if </span><span>(distanceSensor2</span><span style=color:#ed9366>.</span><span style=color:#f29718>checkForDataReady</span><span>()){
</span><span>          distance2 </span><span style=color:#ed9366>=</span><span> distanceSensor2</span><span style=color:#ed9366>.</span><span style=color:#f29718>getDistance</span><span>()</span><span style=color:#61676ccc>;
</span><span>          pid_tof[pid_c] </span><span style=color:#ed9366>=</span><span> distance2</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#f29718>record_IMU</span><span>()</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// store DMP yaw to global var
</span><span>        </span><span style=color:#f29718>pid_orientation_tof</span><span>()</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// do orientation PID with recorded yaw
</span><span>        </span><span style=color:#f29718>apply_pid</span><span>()</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// drives motors according to type of control (pos, ori, or both)
</span><span>
</span><span>        pid_c</span><span style=color:#ed9366>++</span><span style=color:#61676ccc>;
</span><span>
</span><span>        
</span><span>      }
</span><span>
</span><span>      target_orientation </span><span style=color:#ed9366>=</span><span> target_orientation </span><span style=color:#ed9366>+ </span><span style=color:#ff8f40>15</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// set up next measurement
</span><span>
</span><span>    }
</span><span>    
</span><span>    </span><span style=color:#f29718>digitalWrite</span><span>(blinkPin</span><span style=color:#61676ccc>,</span><span> LOW)</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// visual indicator
</span><span>  
</span><span style=color:#fa6e32>break</span><span style=color:#61676ccc>;
</span><span>
</span></code></pre><p>This code ended up working reasonably well, giving me a map of the space which looked accurate at first glance. The robot did have some intermittent issues with skipping PID setpoints, but I was unable to diagnose why. Even so, the map ended up being good enough that I just left it alone.</p><iframe allowfullscreen height=500 src=https://youtube.com/embed/uPLQEA4QUyA width=800></iframe><p>These were the raw TOF and PID control input values (vs time) produced on this run at (5, -3):</p><img alt="first map pid" height=800 src=/files/lab9/firstmap_pid.png><p>Resulting in this polar distance plot:</p><img alt="first map polar plot" height=500 src=/files/lab9/firstmap_polar.png><p>Continuing with these measurements across the space, I was able to get measurements from all four labeled coordinates, as well as the origin:</p><img alt="first map all four" height=900 src=/files/lab9/map1_allfourv2.png><p>I then moved on to translating these datasets into global Cartesian coordinates, using the following matrices:<p>$$ T=\begin{bmatrix}\cos{\theta} & -\sin{\theta} & x \cr \sin{\theta} & \cos{\theta} & y \cr 0 & 0 & 1 \end{bmatrix}<br> $$<p>where $x$ and $y$ are the Cartesian coorodinates from the world origin to center of the car and $\theta$ is the measured angle, and an additional offset<p>$$ P1=\begin{bmatrix}TOF_1 \cr 0\cr 1 \end{bmatrix}<br> $$<p>where $TOF_1$ is the distance from the car's center to the front TOF sensor.<p>I used the recorded orientation values, as I trust the IMU's onboard DMP significantly more than I trust that my robot hit exactly 15 degrees on each rotation. In fact, I'm sure it didn't becasue I saw it skip angles. Regardless, using the DMP yaw angle is clearly the more accurate measureement of the robot's orientation.<p>This gave me the following map:</p><img alt="first map all four" height=800 src=/files/lab9/firstmap_withOrigin.png><p>I determined that my TOF wasn't giving accurate reads of the world over ~1.7m, likely due to mounting angle, so I filtered these values out to recalculate the map:</p><img alt="first map filtered" height=800 src=/files/lab9/map1_filtered.png><p>And, to try to further mitigate the noise I was still seeing in the measurements, I resampled. This time, I only took four readings (all labeled points minus origin), and had the robot rotate 720 degrees (i.e., double the loop count in the first code snippet).<p>This, along with the same distance filter, gave me the following map:</p><img alt="second map filtered" height=800 src=/files/lab9/map2_filtered.png><p>I'm happy with this as an estimate of the world.<h2 id=collaborations><a aria-label="Anchor link for: collaborations" class=zola-anchor href=#collaborations>Collaborations</a></h2><p>I worked with <a href=https://correial.github.io/>Lucca Correia</a> and <a href=https://trevordales.github.io/>Trevor Dales</a> extensively. I used ChatGPT to help with curve fitting and generating nice plots.<h1 id=next-lab-8><a aria-label="Anchor link for: next-lab-8" class=zola-anchor href=#next-lab-8>Next: <a href=/fast-robots/lab8>Lab 8</a></a></h1></section></article></main><div class=giscus></div><script -- <!-- <-- change repo src=https://utteranc.es/client.js this to your>issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async></script></div>