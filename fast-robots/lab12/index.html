<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://jack-d-long.github.io/ name=base><title>
         Lab 12
        
    </title><meta content="Lab 12" property=og:title><meta content="This is an example description" property=og:description><meta content="This is an example description" name=description><link href=/alien.png rel=icon type=image/png><link href=https://jack-d-long.github.io/fonts.css rel=stylesheet><script src=https://jack-d-long.github.io/js/codeblock.js></script><script src=https://jack-d-long.github.io/js/toc.js></script><script src=https://jack-d-long.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Jack Long" href=https://jack-d-long.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://jack-d-long.github.io/theme/light.css rel=stylesheet><link href=https://jack-d-long.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://jack-d-long.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://jack-d-long.github.io/main.css media=screen rel=stylesheet><script src=https://jack-d-long.github.io/js/mermaid.js></script><script src="https://jack-d-long.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://jack-d-long.github.io/>Jack Long</a><div class=socials><a class=social href=https://linkedin.com/in/jacklong257 rel=me> <img alt=linkedin src=https://jack-d-long.github.io/social_icons/linkedin.svg> </a><a class=social href=https://github.com/jack-d-long/ rel=me> <img alt=github src=https://jack-d-long.github.io/social_icons/github.svg> </a></div></div><nav><a href=https://jack-d-long.github.io/portfolio style=margin-left:.25em>/portfolio</a><a href=https://jack-d-long.github.io/about style=margin-left:.25em>/about</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://jack-d-long.github.io/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://jack-d-long.github.io/feather/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://jack-d-long.github.io/feather/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><main><article><div class=title><div class=page-header>Lab 12<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2025-05-12</time></div></div><div class=toc-container><h1 class=toc-title>Table of Contents</h1><ul class=toc-list><li><a href=https://jack-d-long.github.io/fast-robots/lab12/#previous-lab-11>Previous: Lab 11</a> <ul><li><a href=https://jack-d-long.github.io/fast-robots/lab12/#intro>Intro</a></li><ul><li><a href=https://jack-d-long.github.io/fast-robots/lab12/#goal-waypoints>Goal Waypoints</a></ul><li><a href=https://jack-d-long.github.io/fast-robots/lab12/#logic-and-control-flow>Logic and Control Flow</a></li><ul><li><a href=https://jack-d-long.github.io/fast-robots/lab12/#1-turn-toward-the-next-waypoint>1. Turn Toward the Next Waypoint</a><li><a href=https://jack-d-long.github.io/fast-robots/lab12/#2-read-current-tof-sensor-data>2. Read Current TOF Sensor Data:</a><li><a href=https://jack-d-long.github.io/fast-robots/lab12/#3-move-toward-the-waypoint>3. Move Toward the Waypoint:</a><li><a href=https://jack-d-long.github.io/fast-robots/lab12/#4-update-robot-location>4. Update Robot Location:</a></ul><li><a href=https://jack-d-long.github.io/fast-robots/lab12/#python-implementation>Python Implementation</a><li><a href=https://jack-d-long.github.io/fast-robots/lab12/#onboard-control>Onboard Control</a><li><a href=https://jack-d-long.github.io/fast-robots/lab12/#results>Results</a><li><a href=https://jack-d-long.github.io/fast-robots/lab12/#collaborations>Collaborations</a></ul></ul></div><section class=body><h1 id=previous-lab-11><a aria-label="Anchor link for: previous-lab-11" class=zola-anchor href=#previous-lab-11>Previous: <a href=/fast-robots/lab11>Lab 11</a></a></h1><h2 id=intro><a aria-label="Anchor link for: intro" class=zola-anchor href=#intro>Intro</a></h2><p>I worked with <a href=https://correial.github.io/>Lucca </a> and <a href=https://trevordales.github.io/>Trevor Dales</a> to navigate our robot through a preset route of waypoints assigned to us in the lab. Overall, we were very successful in arriving and navigating through these waypoints completely autonomously with a combination of onboard PID control and offboard localization with the Bayes filter! The final result was incredibly rewarding as it required us to combine and implement various aspects of code and hardware debugging learned throughout the semester in addition to navigation and waypoint logic for this lab. Note that we also considered an obstacle avoidance algorithm, but ran out of time to implement it within our lower-level control loop. This might have made our robot less robust to outside disturbances, but our navigation was still accurate within the lab.<p>We began with complementary arrays of waypoints and localization booleans (i.e. a point, and a boolean to signal the script to localize at that waypoint). This allowed us to manually assign which points we localized at based on the accuracy of localization at each waypoint for the most accurate navigation. To navigate between points, we used sequential orientation and position PID using the DMP onboard our IMU, and Kalman-filtered TOF sensor, respectively.<p>We used Lucca’s robot for this lab, and collaborated jointly on both Arduino and Python code components!<h3 id=goal-waypoints><a aria-label="Anchor link for: goal-waypoints" class=zola-anchor href=#goal-waypoints>Goal Waypoints</a></h3><img alt=wpts!! src=/files/lab12/wpts.png width=800><h2 id=logic-and-control-flow><a aria-label="Anchor link for: logic-and-control-flow" class=zola-anchor href=#logic-and-control-flow>Logic and Control Flow</a></h2><p>The navigation path is defined by a list of 2D waypoints <code>waypoint_list</code>, with each point representing a target location in feet. An accompanying list of boolean flags <code>localize_flags</code> determines whether the robot should re-localize its position at each waypoint using a grid-based localization system. The script continuously loops through all waypoints in sequence, executing the following steps for each:<h3 id=1-turn-toward-the-next-waypoint><a aria-label="Anchor link for: 1-turn-toward-the-next-waypoint" class=zola-anchor href=#1-turn-toward-the-next-waypoint>1. Turn Toward the Next Waypoint</a></h3><ul><li><p>Calculates the angle between the robot’s current position and the next waypoint using the <code>atan2</code> function.</p><li><p>Sends an angular PID control command over BLE to rotate the robot to the calculated heading (<code>CMD.PID_TURN_CONTROL</code> , described in Onboard Control section)</p></ul><h3 id=2-read-current-tof-sensor-data><a aria-label="Anchor link for: 2-read-current-tof-sensor-data" class=zola-anchor href=#2-read-current-tof-sensor-data>2. Read Current TOF Sensor Data:</a></h3><ul><li><p>Requests the current pose from the robot (<code>CMD.SEND_CURRENT_POSE</code>, which serves position data from the TOF over BLE).</p><li><p>Extracts the distance reading from the CSV.</p></ul><h3 id=3-move-toward-the-waypoint><a aria-label="Anchor link for: 3-move-toward-the-waypoint" class=zola-anchor href=#3-move-toward-the-waypoint>3. Move Toward the Waypoint:</a></h3><ul><li><p>Computes the expected distance to the next waypoint based on current position belief, and knowing that the robot's angle is always zero after mapping.</p><li><p>Subtracts the distance to the next point from the current TOF reading to calculate the necessary target distance for the next motion.</p><li><p>Sends a PID control command over Bluetooth to move the robot forward to the calculated target. (<code>CMD.PID_CONTROL</code> , described in Onboard Control section)</p></ul><h3 id=4-update-robot-location><a aria-label="Anchor link for: 4-update-robot-location" class=zola-anchor href=#4-update-robot-location>4. Update Robot Location:</a></h3><ul><li>If localization is enabled for the current waypoint, the robot turns to zero degrees and then performs an observation scan (function <code>perform_observation_loop</code>) and sends the data through BLE. Then, an update step is performed to estimate the robot’s current position.<li>If localization is disabled, the robot’s position is assumed to be exactly at the waypoint.<li>Note that the angle of the robot is always measured with the DMP from the horizontal (start) position as we found this to be significantly more accurate than any estimate from the Bayes filter, even with inconsistencies in how we started each test run.</ul><h2 id=python-implementation><a aria-label="Anchor link for: python-implementation" class=zola-anchor href=#python-implementation>Python Implementation</a></h2><p>To realize the above plan, we wrote the following script.<div class=note-container><button class=note-toggle><div class=note-icon><p>lab_12_pathplanning.ipynb</div></button><div class=note-content style=display:block><pre class=language-python data-lang=python style=color:#61676c;background-color:#fafafa><code class=language-python data-lang=python><span>
</span><span style=color:#fa6e32>async def </span><span style=color:#f29718>recieveData</span><span>(</span><span style=color:#ff8f40>localizing</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>current_waypoint</span><span>):
</span><span style=color:#abb0b6;font-style:italic># return current location, current orientation
</span><span>    current_loc </span><span style=color:#ed9366>= </span><span>[</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>]
</span><span>    </span><span style=color:#f07171>print</span><span>(</span><span style=color:#86b300>"localizing: "</span><span style=color:#61676ccc>,</span><span>localizing)
</span><span>    </span><span style=color:#fa6e32>if </span><span>localizing:
</span><span>        </span><span style=color:#fa6e32>await </span><span>loc</span><span style=color:#ed9366>.</span><span style=color:#f29718>get_observation_data</span><span>()
</span><span>        
</span><span>        </span><span style=color:#abb0b6;font-style:italic># Run Update Step
</span><span>        loc</span><span style=color:#ed9366>.</span><span style=color:#f29718>update_step</span><span>()
</span><span>        belief </span><span style=color:#ed9366>= </span><span>loc</span><span style=color:#ed9366>.</span><span style=color:#f29718>plot_update_step_data</span><span>(</span><span style=color:#ff8f40>plot_data</span><span style=color:#ed9366>=</span><span style=color:#ff8f40>True</span><span>)
</span><span>        
</span><span>        current_loc[</span><span style=color:#ff8f40>0</span><span>] </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>3</span><span style=color:#61676ccc>.</span><span style=color:#ff8f40>281</span><span style=color:#ed9366>*</span><span>belief[</span><span style=color:#ff8f40>0</span><span>] </span><span style=color:#abb0b6;font-style:italic># x
</span><span>        current_loc[</span><span style=color:#ff8f40>1</span><span>] </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>3</span><span style=color:#61676ccc>.</span><span style=color:#ff8f40>281</span><span style=color:#ed9366>*</span><span>belief[</span><span style=color:#ff8f40>1</span><span>] </span><span style=color:#abb0b6;font-style:italic># y
</span><span>
</span><span>    </span><span style=color:#fa6e32>else</span><span>:
</span><span>        </span><span style=color:#abb0b6;font-style:italic>#assume we are at the waypoint
</span><span>        current_loc </span><span style=color:#ed9366>= </span><span>[current_waypoint[</span><span style=color:#ff8f40>0</span><span>]</span><span style=color:#61676ccc>, </span><span>current_waypoint[</span><span style=color:#ff8f40>1</span><span>]] </span><span style=color:#abb0b6;font-style:italic>#set current location to x,y of the current waypoint
</span><span>        cmdr</span><span style=color:#ed9366>.</span><span style=color:#f29718>plot_bel</span><span>(current_waypoint[</span><span style=color:#ff8f40>0</span><span>]</span><span style=color:#ed9366>/</span><span style=color:#ff8f40>3</span><span style=color:#61676ccc>.</span><span style=color:#ff8f40>281</span><span style=color:#61676ccc>, </span><span>current_waypoint[</span><span style=color:#ff8f40>1</span><span>]</span><span style=color:#ed9366>/</span><span style=color:#ff8f40>3</span><span style=color:#61676ccc>.</span><span style=color:#ff8f40>281</span><span>)
</span><span>       
</span><span>    </span><span style=color:#fa6e32>return </span><span>current_loc
</span><span>
</span><span style=color:#fa6e32>def </span><span style=color:#f29718>calculateTargetAngle</span><span>(</span><span style=color:#ff8f40>x</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>y</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>next_waypoint</span><span>):
</span><span>    </span><span style=color:#abb0b6;font-style:italic># based on current location, calculate and return required angle
</span><span>    x2 </span><span style=color:#ed9366>= </span><span>next_waypoint[</span><span style=color:#ff8f40>0</span><span>]
</span><span>    y2 </span><span style=color:#ed9366>= </span><span>next_waypoint[</span><span style=color:#ff8f40>1</span><span>]
</span><span>    
</span><span>    angle_rad </span><span style=color:#ed9366>= </span><span>math</span><span style=color:#ed9366>.</span><span style=color:#f29718>atan2</span><span>(y2 </span><span style=color:#ed9366>- </span><span>y</span><span style=color:#61676ccc>, </span><span>x2 </span><span style=color:#ed9366>- </span><span>x)
</span><span>    target_angle_deg </span><span style=color:#ed9366>= </span><span>math</span><span style=color:#ed9366>.</span><span style=color:#f29718>degrees</span><span>(angle_rad)
</span><span>   
</span><span>    </span><span style=color:#fa6e32>return </span><span>target_angle_deg
</span><span>
</span><span style=color:#fa6e32>def </span><span style=color:#f29718>calculateTargetDistance</span><span>(</span><span style=color:#ff8f40>x</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>y</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>current_tof</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>next_waypoint</span><span>):
</span><span>    </span><span style=color:#abb0b6;font-style:italic>#Implement logic
</span><span>
</span><span>    x2 </span><span style=color:#ed9366>= </span><span>next_waypoint[</span><span style=color:#ff8f40>0</span><span>]
</span><span>    y2 </span><span style=color:#ed9366>= </span><span>next_waypoint[</span><span style=color:#ff8f40>1</span><span>]
</span><span>   
</span><span>    distance_to_next_waypoint </span><span style=color:#ed9366>= </span><span>math</span><span style=color:#ed9366>.</span><span style=color:#f29718>sqrt</span><span>((x2 </span><span style=color:#ed9366>- </span><span>x)</span><span style=color:#ed9366>**</span><span style=color:#ff8f40>2 </span><span style=color:#ed9366>+ </span><span>(y2 </span><span style=color:#ed9366>- </span><span>y)</span><span style=color:#ed9366>**</span><span style=color:#ff8f40>2</span><span>)
</span><span>    distance_to_next_waypoint </span><span style=color:#ed9366>= </span><span>distance_to_next_waypoint</span><span style=color:#ed9366>*</span><span style=color:#ff8f40>304</span><span style=color:#61676ccc>.</span><span style=color:#ff8f40>8 </span><span style=color:#abb0b6;font-style:italic>#convert from ft to mm
</span><span>   
</span><span>    target_distance_mm </span><span style=color:#ed9366>= </span><span>current_tof </span><span style=color:#ed9366>- </span><span>distance_to_next_waypoint
</span><span>    </span><span style=color:#fa6e32>return </span><span>target_distance_mm
</span><span>
</span><span style=color:#abb0b6;font-style:italic># Reset Plots
</span><span>cmdr</span><span style=color:#ed9366>.</span><span style=color:#f29718>reset_plotter</span><span>()
</span><span>
</span><span style=color:#abb0b6;font-style:italic># Init Uniform Belief
</span><span>loc</span><span style=color:#ed9366>.</span><span style=color:#f29718>init_grid_beliefs</span><span>()
</span><span>
</span><span>waypoint_list </span><span style=color:#ed9366>= </span><span>[(</span><span style=color:#ed9366>-</span><span style=color:#ff8f40>4</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>3</span><span>)</span><span style=color:#61676ccc>, </span><span>(</span><span style=color:#ed9366>-</span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>, </span><span>(</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>, </span><span>(</span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>3</span><span>)</span><span style=color:#61676ccc>, </span><span>(</span><span style=color:#ff8f40>5</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>3</span><span>)</span><span style=color:#61676ccc>, </span><span>(</span><span style=color:#ff8f40>5</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>2</span><span>)</span><span style=color:#61676ccc>, </span><span>(</span><span style=color:#ff8f40>5</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>3</span><span>)</span><span style=color:#61676ccc>, </span><span>(</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>3</span><span>)</span><span style=color:#61676ccc>,</span><span>(</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>)]
</span><span>localize_flags </span><span style=color:#ed9366>= </span><span>[</span><span style=color:#ff8f40>False</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>True</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>False</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>False</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>False</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>True</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>True</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>True</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>True</span><span>]  </span><span style=color:#abb0b6;font-style:italic># encode whether to localize at a waypoint
</span><span>
</span><span>current_loc </span><span style=color:#ed9366>= </span><span>[</span><span style=color:#ed9366>-</span><span style=color:#ff8f40>4</span><span style=color:#61676ccc>,</span><span style=color:#ed9366>-</span><span style=color:#ff8f40>3</span><span>] </span><span style=color:#abb0b6;font-style:italic>#initialize starting loc as the first waypoint
</span><span>current_tof </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0 </span><span style=color:#abb0b6;font-style:italic># [mm]
</span><span>cmdr</span><span style=color:#ed9366>.</span><span style=color:#f29718>plot_bel</span><span>(current_loc[</span><span style=color:#ff8f40>0</span><span>]</span><span style=color:#ed9366>/</span><span style=color:#ff8f40>3</span><span style=color:#61676ccc>.</span><span style=color:#ff8f40>281</span><span style=color:#61676ccc>, </span><span>current_loc[</span><span style=color:#ff8f40>1</span><span>]</span><span style=color:#ed9366>/</span><span style=color:#ff8f40>3</span><span style=color:#61676ccc>.</span><span style=color:#ff8f40>281</span><span>)
</span><span>
</span><span style=color:#fa6e32>while </span><span style=color:#ff8f40>True</span><span>:
</span><span>   
</span><span>    </span><span style=color:#fa6e32>for </span><span>i </span><span style=color:#fa6e32>in </span><span style=color:#f07171>range</span><span>(</span><span style=color:#f07171>len</span><span>(waypoint_list)): </span><span style=color:#abb0b6;font-style:italic># i represents current waypoint (starts at zero)
</span><span>
</span><span>        target_angle </span><span style=color:#ed9366>= </span><span style=color:#f29718>calculateTargetAngle</span><span>(current_loc[</span><span style=color:#ff8f40>0</span><span>]</span><span style=color:#61676ccc>, </span><span>current_loc[</span><span style=color:#ff8f40>1</span><span>]</span><span style=color:#61676ccc>, </span><span>waypoint_list[i</span><span style=color:#ed9366>+</span><span style=color:#ff8f40>1</span><span>])
</span><span>        </span><span style=color:#f07171>print</span><span>(</span><span style=color:#86b300>"Target angle:"</span><span style=color:#61676ccc>, </span><span>target_angle)
</span><span>   
</span><span>        ble</span><span style=color:#ed9366>.</span><span style=color:#f29718>send_command</span><span>(CMD</span><span style=color:#ed9366>.</span><span>PID_TURN_CONTROL</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>f</span><span style=color:#86b300>"1.1|0|120|</span><span>{target_angle}</span><span style=color:#86b300>"</span><span>) </span><span style=color:#abb0b6;font-style:italic># P|I|D
</span><span>
</span><span>        </span><span style=color:#fa6e32>await </span><span>asyncio</span><span style=color:#ed9366>.</span><span style=color:#f29718>sleep</span><span>(</span><span style=color:#ff8f40>5</span><span>)
</span><span>
</span><span>        ble</span><span style=color:#ed9366>.</span><span style=color:#f29718>send_command</span><span>(CMD</span><span style=color:#ed9366>.</span><span>SEND_CURRENT_POSE</span><span style=color:#61676ccc>, </span><span style=color:#86b300>""</span><span>)
</span><span>        
</span><span>        </span><span style=color:#fa6e32>await </span><span>asyncio</span><span style=color:#ed9366>.</span><span style=color:#f29718>sleep</span><span>(</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>.</span><span style=color:#ff8f40>0</span><span>)
</span><span>
</span><span>        df </span><span style=color:#ed9366>= </span><span>pd</span><span style=color:#ed9366>.</span><span style=color:#f29718>read_csv</span><span>(</span><span style=color:#86b300>"MappingData.csv"</span><span>)
</span><span>        current_tof </span><span style=color:#ed9366>= </span><span>df[</span><span style=color:#86b300>"TOF"</span><span>]</span><span style=color:#ed9366>.</span><span>iloc[</span><span style=color:#ff8f40>0</span><span>]
</span><span>        
</span><span>        </span><span style=color:#f07171>print</span><span>(</span><span style=color:#86b300>"Current TOF:"</span><span style=color:#61676ccc>, </span><span>current_tof)
</span><span>
</span><span>        target_distance </span><span style=color:#ed9366>= </span><span style=color:#f29718>calculateTargetDistance</span><span>(current_loc[</span><span style=color:#ff8f40>0</span><span>]</span><span style=color:#61676ccc>, </span><span>current_loc[</span><span style=color:#ff8f40>1</span><span>]</span><span style=color:#61676ccc>, </span><span>current_tof</span><span style=color:#61676ccc>, </span><span>waypoint_list[i</span><span style=color:#ed9366>+</span><span style=color:#ff8f40>1</span><span>])
</span><span>
</span><span>        </span><span style=color:#f07171>print</span><span>(</span><span style=color:#86b300>"Target Distance:"</span><span style=color:#61676ccc>, </span><span>target_distance)
</span><span>        
</span><span>        ble</span><span style=color:#ed9366>.</span><span style=color:#f29718>send_command</span><span>(CMD</span><span style=color:#ed9366>.</span><span>PID_CONTROL</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>f</span><span style=color:#86b300>".14|0|40|</span><span>{target_distance}</span><span style=color:#86b300>"</span><span>) </span><span style=color:#abb0b6;font-style:italic># P|I|D
</span><span>
</span><span>        </span><span style=color:#fa6e32>await </span><span>asyncio</span><span style=color:#ed9366>.</span><span style=color:#f29718>sleep</span><span>(</span><span style=color:#ff8f40>10</span><span style=color:#61676ccc>.</span><span style=color:#ff8f40>0</span><span>)
</span><span>
</span><span>        current_loc </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>await </span><span style=color:#f29718>recieveData</span><span>(localize_flags[i]</span><span style=color:#61676ccc>, </span><span>waypoint_list[i</span><span style=color:#ed9366>+</span><span style=color:#ff8f40>1</span><span>])
</span><span>        </span><span style=color:#f07171>print</span><span>(</span><span style=color:#86b300>"Current Location:"</span><span style=color:#61676ccc>, </span><span>current_loc)
</span><span>
</span><span>        </span><span style=color:#fa6e32>with </span><span style=color:#f07171>open</span><span>(</span><span style=color:#86b300>"MappingData.csv"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"w"</span><span>) </span><span style=color:#fa6e32>as </span><span>f:
</span><span>            f</span><span style=color:#ed9366>.</span><span style=color:#f29718>truncate</span><span>()
</span><span>
</span><span>
</span><span>        </span><span style=color:#f07171>print</span><span>(</span><span style=color:#86b300>"------------------------------------------------------------"</span><span>)
</span><span>
</span><span>
</span><span>
</span></code></pre></div></div><p>All BLE commands are explained below.<h2 id=onboard-control><a aria-label="Anchor link for: onboard-control" class=zola-anchor href=#onboard-control>Onboard Control</a></h2><p>Note that all data sent over from the Artemis to the computer over BLE is processed and piped into a CSV file by a notification handler. This CSV file is reset at specific points throughout the Python script before new TOF and Gyro data comes in.<p>Initially, an <code>arrived</code> boolean flag (triggered when the robot arrived within a threshold of the target angle or distance) was used to end the PID control and move to the next step in our larger control loop. However, this meant that if we slightly overshot the target, the flag would flip true and disable the control required to return to the target.<p>We tried to severly overdampen both orientation and linear PID to fix this, however it left us with too much steady-state error given the variability of our deadband with battery voltage.<p>Our solution was implementing a simple 5 second cutoff timer before stopping the PID loop. While not the most elegant solution, this gave us plenty of time to approach angles/distances and eliminated the issue of early PID stoppage. <code>getDMP()</code>, <code>RunPIDLin()</code>, and <code>RunPIDRot()</code> are well-documented in previous labs, and handle the lowest level of data acquisition, filtering, and motor control. The <code>clearVariables()</code> function is seen in all cases used in this lab; it resets counters and recorded datapoints to ensure the Artemis doesn't run out of memory over long execution times.<p>For angular PID, we used:<div class=note-container><button class=note-toggle><div class=note-icon><p>CMD.PID_TURN_CONTROL</div></button><div class=note-content style=display:block><pre class=language-c++ data-lang=c++ style=color:#61676c;background-color:#fafafa><code class=language-c++ data-lang=c++><span style=color:#abb0b6;font-style:italic>// Get PID parameters over BLE
</span><span>success </span><span style=color:#ed9366>=</span><span> robot_cmd</span><span style=color:#ed9366>.</span><span style=color:#f29718>get_next_value</span><span>(Kp_turn)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if </span><span>(</span><span style=color:#ed9366>!</span><span>success) </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// Same for Kd & Ki
</span><span style=color:#ed9366>...
</span><span>
</span><span>success </span><span style=color:#ed9366>=</span><span> robot_cmd</span><span style=color:#ed9366>.</span><span style=color:#f29718>get_next_value</span><span>(target_turn)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if </span><span>(</span><span style=color:#ed9366>!</span><span>success) </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>tx_estring_value</span><span style=color:#ed9366>.</span><span style=color:#f29718>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Variables used for cutoff timer (5 s)
</span><span style=color:#ed9366>...
</span><span>
</span><span style=color:#fa6e32>int</span><span> turn_cutoff </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>5000</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>while </span><span>( (</span><span style=color:#f29718>millis</span><span>() </span><span style=color:#ed9366>-</span><span> turn_starttime) </span><span style=color:#ed9366>&lt;</span><span> turn_cutoff ) { 
</span><span>    </span><span style=color:#f29718>getDMP</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f29718>runPIDRot</span><span>()</span><span style=color:#61676ccc>;
</span><span>    counter_turn </span><span style=color:#ed9366>+= </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>
</span><span>}
</span><span style=color:#f29718>stop</span><span>()</span><span style=color:#61676ccc>;
</span><span>pidTurn_start </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span style=color:#f29718>clearVariables</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>break</span><span style=color:#61676ccc>;
</span></code></pre></div></div><p>and for linear PID:<div class=note-container><button class=note-toggle><div class=note-icon><p>CMD.PID_CONTROL</div></button><div class=note-content style=display:block><pre class=language-c++ data-lang=c++ style=color:#61676c;background-color:#fafafa><code class=language-c++ data-lang=c++><span>distanceSensor1</span><span style=color:#ed9366>.</span><span style=color:#f29718>startRanging</span><span>()</span><span style=color:#61676ccc>;
</span><span>pid_start </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// Get PID parameters over BLE
</span><span>success </span><span style=color:#ed9366>=</span><span> robot_cmd</span><span style=color:#ed9366>.</span><span style=color:#f29718>get_next_value</span><span>(Kp)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if </span><span>(</span><span style=color:#ed9366>!</span><span>success) </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// Same for Kd & Ki
</span><span style=color:#ed9366>...
</span><span>
</span><span>success </span><span style=color:#ed9366>=</span><span> robot_cmd</span><span style=color:#ed9366>.</span><span style=color:#f29718>get_next_value</span><span>(target_tof)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if </span><span>(</span><span style=color:#ed9366>!</span><span>success) </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>tx_estring_value</span><span style=color:#ed9366>.</span><span style=color:#f29718>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Variables used for cutoff timer (7 s)
</span><span style=color:#ed9366>...
</span><span style=color:#fa6e32>int</span><span> linear_cutoff </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>7000</span><span style=color:#61676ccc>; 
</span><span>
</span><span style=color:#fa6e32>while </span><span>((</span><span style=color:#f29718>millis</span><span>() </span><span style=color:#ed9366>-</span><span> linear_starttime) </span><span style=color:#ed9366>&lt;</span><span> linear_cutoff) { </span><span style=color:#abb0b6;font-style:italic>// hard time cutoff
</span><span>    </span><span style=color:#f29718>runPIDLin</span><span>()</span><span style=color:#61676ccc>;
</span><span>    counter_lin </span><span style=color:#ed9366>=</span><span> counter_lin </span><span style=color:#ed9366>+ </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>}
</span><span>    </span><span style=color:#f29718>stop</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f29718>clearVariables</span><span>()</span><span style=color:#61676ccc>;
</span><span>    run </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>break</span><span style=color:#61676ccc>;
</span><span>
</span></code></pre></div></div><p>We performed our mapping in a case outside of the mainloop for simplicity. It's taken mostly from lab 11, but implements the same changes as above (adding a timer) to improve robustness at the cost of speed.<div class=note-container><button class=note-toggle><div class=note-icon><p>CMD.SPIN</div></button><div class=note-content style=display:block><pre class=language-c++ data-lang=c++ style=color:#61676c;background-color:#fafafa><code class=language-c++ data-lang=c++><span style=color:#fa6e32>case</span><span> SPIN</span><span style=color:#61676ccc>:</span><span>{
</span><span>    distanceSensor1</span><span style=color:#ed9366>.</span><span style=color:#f29718>startRanging</span><span>()</span><span style=color:#61676ccc>;
</span><span>    success </span><span style=color:#ed9366>=</span><span> robot_cmd</span><span style=color:#ed9366>.</span><span style=color:#f29718>get_next_value</span><span>(Kp_turn)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if </span><span>(</span><span style=color:#ed9366>!</span><span>success) </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>    success </span><span style=color:#ed9366>=</span><span> robot_cmd</span><span style=color:#ed9366>.</span><span style=color:#f29718>get_next_value</span><span>(Ki_turn)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if </span><span>(</span><span style=color:#ed9366>!</span><span>success) </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>    success </span><span style=color:#ed9366>=</span><span> robot_cmd</span><span style=color:#ed9366>.</span><span style=color:#f29718>get_next_value</span><span>(Kd_turn)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if </span><span>(</span><span style=color:#ed9366>!</span><span>success) </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Time varaibles
</span><span>    spin_time </span><span style=color:#ed9366>= </span><span style=color:#f29718>millis</span><span>()</span><span style=color:#61676ccc>;
</span><span>    start_time_pid_turn </span><span style=color:#ed9366>= </span><span style=color:#f29718>millis</span><span>()</span><span style=color:#61676ccc>;
</span><span>    last_rotation_time </span><span style=color:#ed9366>= </span><span style=color:#f29718>millis</span><span>()</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#fa6e32>while </span><span>((spin_counter </span><span style=color:#ed9366>&lt;</span><span> spin_len) </span><span style=color:#ed9366>&& </span><span>(rot_counter </span><span style=color:#ed9366>&lt;= </span><span style=color:#ff8f40>36</span><span>)) {
</span><span>        
</span><span>        </span><span style=color:#f29718>getDMP</span><span>()</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#f29718>runPIDRot</span><span>()</span><span style=color:#61676ccc>;
</span><span>        
</span><span>        spinTime[spin_counter] </span><span style=color:#ed9366>= </span><span style=color:#f29718>millis</span><span>() </span><span style=color:#ed9366>-</span><span> spin_time</span><span style=color:#61676ccc>;
</span><span>        
</span><span>        elapsed_time </span><span style=color:#ed9366>= </span><span style=color:#f29718>millis</span><span>() </span><span style=color:#ed9366>-</span><span> last_rot_time</span><span style=color:#61676ccc>;
</span><span>        
</span><span>        </span><span style=color:#fa6e32>if </span><span>((start_time </span><span style=color:#ed9366>- </span><span style=color:#f29718>millis</span><span>()) </span><span style=color:#ed9366>&lt; </span><span style=color:#ff8f40>750</span><span>) {
</span><span>            </span><span style=color:#f29718>collectTOF</span><span>()</span><span style=color:#61676ccc>;
</span><span>            last_rot_time </span><span style=color:#ed9366>= </span><span style=color:#f29718>millis</span><span>()</span><span style=color:#61676ccc>;
</span><span>            rot_counter </span><span style=color:#ed9366>=</span><span> rot_counter </span><span style=color:#ed9366>+ </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>            target_turn </span><span style=color:#ed9366>=</span><span> target_turn </span><span style=color:#ed9366>+ </span><span style=color:#ff8f40>10</span><span style=color:#61676ccc>;
</span><span>        }   
</span><span>        spin_counter </span><span style=color:#ed9366>=</span><span> spin_counter </span><span style=color:#ed9366>+ </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#f29718>stop</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f29718>sendMapData</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>break</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre></div></div><h2 id=results><a aria-label="Anchor link for: results" class=zola-anchor href=#results>Results</a></h2><p>Below are a series of trials from our lab! In the last two runs you can see a live belief map and logging in Jupyter Notebook, which ouputs critical information like whether we localize at that specific waypoint, our current belief pose, our calculated target heading, etc. Note that we chose points to localize that the robot was least consistent in reaching, and left other points entirely up to the lower-level-control.</p><iframe allowfullscreen height=500 src=https://youtube.com/embed/_luMDGDUHVw width=800></iframe><p>We saw a lot of success with the structure of our high-level planning on the first run, but ran into trouble with inconsistencies in lower-level control and angle targeting. When we localized, our planner output was correct based on position belief, but we struggled to tune the orientation PID loop in such a way that it responded (similarly) well to changes in angle between 10 and 180 degrees, while settling within a reasonable time. We changed our approach to add a time cutoff to both control loops, sacrificing a bit of accuracy for longer-term operation.</p><iframe allowfullscreen height=500 src=https://youtube.com/embed/ufMTsQO14IY width=800></iframe><p>Note: We had to to nudge the robot at <code>(-5,-3)</code> to keep it on track as the TOFs appeared to slightly overestimate the target distance, which would have led to our robot crashing into the square obstacle. We also had some of the same issues with lower-level orientation control (unprecidented derivative gain) during mapping at <code>(5,3)</code>, which we had to manually fix. Otherwise, this run was almost a complete success!</p><iframe allowfullscreen height=500 src=https://youtube.com/embed/LJK30JyzM_U width=800></iframe><p>Here's the money shot. After all of our modifications, the robot was finally able to plan and execute a complete circuit around the world autonomously. Although each point wasn't reached with complete accuracy (see <code>(5, 3)</code>), the Bayes filter was able to bridge the gap and keep our robot on track throughout the run.<h2 id=collaborations><a aria-label="Anchor link for: collaborations" class=zola-anchor href=#collaborations>Collaborations</a></h2><p>I worked with <a href=https://correial.github.io/>Lucca Correia</a> and <a href=https://trevordales.github.io/>Trevor Dales</a> to complete this lab with Lucca's robot. We used ChatGPT to verify Python implementation of our geometry for the high-level path planning. I also want to shoutout <a href="https://www.youtube.com/watch?v=sJXWscXF3t4">Kobe</a>, who provided extreme moral support throughout this lab.</section></article></main><div class=giscus></div><script -- <!-- <-- change repo src=https://utteranc.es/client.js this to your>issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async></script></div>