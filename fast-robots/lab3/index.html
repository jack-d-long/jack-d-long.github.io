<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://jack-d-long.github.io/ name=base><title>
         Lab 3
        
    </title><meta content="Lab 3" property=og:title><meta content="This is an example description" property=og:description><meta content="This is an example description" name=description><link href=/alien.png rel=icon type=image/png><link href=https://jack-d-long.github.io/fonts.css rel=stylesheet><script src=https://jack-d-long.github.io/js/codeblock.js></script><script src=https://jack-d-long.github.io/js/toc.js></script><script src=https://jack-d-long.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Jack Long" href=https://jack-d-long.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://jack-d-long.github.io/theme/light.css rel=stylesheet><link href=https://jack-d-long.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://jack-d-long.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://jack-d-long.github.io/main.css media=screen rel=stylesheet><script src=https://jack-d-long.github.io/js/mermaid.js></script><script src="https://jack-d-long.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://jack-d-long.github.io/>Jack Long</a><div class=socials><a class=social href=https://linkedin.com/in/jacklong257 rel=me> <img alt=linkedin src=https://jack-d-long.github.io/social_icons/linkedin.svg> </a><a class=social href=https://github.com/jack-d-long/ rel=me> <img alt=github src=https://jack-d-long.github.io/social_icons/github.svg> </a></div></div><nav><a href=https://jack-d-long.github.io/portfolio style=margin-left:.25em>/portfolio</a><a href=https://jack-d-long.github.io/about style=margin-left:.25em>/about</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://jack-d-long.github.io/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://jack-d-long.github.io/feather/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://jack-d-long.github.io/feather/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><main><article><div class=title><div class=page-header>Lab 3<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2025-02-13</time></div></div><div class=toc-container><h1 class=toc-title>Table of Contents</h1><ul class=toc-list><li><a href=https://jack-d-long.github.io/fast-robots/lab3/#previous-lab-2>Previous: Lab 2</a><li><a href=https://jack-d-long.github.io/fast-robots/lab3/#prelab>Prelab</a><li><a href=https://jack-d-long.github.io/fast-robots/lab3/#lab-tasks>Lab Tasks</a> <ul><li><a href=https://jack-d-long.github.io/fast-robots/lab3/#collaborations>Collaborations</a></ul><li><a href=https://jack-d-long.github.io/fast-robots/lab3/#next-lab-4>Next: Lab 4</a></ul></div><section class=body><h1 id=previous-lab-2><a aria-label="Anchor link for: previous-lab-2" class=zola-anchor href=#previous-lab-2>Previous: <a href=/fast-robots/lab2>Lab 2</a></a></h1><h1 id=prelab><a aria-label="Anchor link for: prelab" class=zola-anchor href=#prelab>Prelab</a></h1><p>We use two sensors because don't have great sample rate per TOF, so we make up for it with more samples. But because both sensors have the same default I2C address, we must include an additional connection to shut off one TOF while we modify the I2C address of the other, like so:</p><img alt=wiring src=/files/lab3/wiring.png width=600><p>I plan to put both TOFs on the front of my robot. While this may cause it to miss some obstacles to its left and right, I believe that these issues will be mitigated with proper angle control of the robot. When placed in an unfamiliar environment, it can simply do a 360 degree spin to map it out. I believe that interpretation of the sensor data will be easiest with them both in the same location on the robot.<h1 id=lab-tasks><a aria-label="Anchor link for: lab-tasks" class=zola-anchor href=#lab-tasks>Lab Tasks</a></h1><p>Below, you can see my implementation of this wiring scheme, with a video of the demo I2C scanning code.</p><img alt=setup src=/files/lab3/setup.png width=600><iframe allowfullscreen height=400 src=https://youtube.com/embed/EZeENgkbHYw width=600></iframe><p>Initially, the Artemis reads the default I2C address of the TOF as 0x29 (0b 0010 1001). Because the least significant bit of this address is used to indicate read/write, we can shift it left to obtain the I2C address as printed on the datasheet, 0x52 (0b 0101 0010).<p>I chose the long mode - The resolution at short distances is still sufficient to avoid collisions, but is better at long (on a room scale) distances where mapping will be more useful.<p>Using two TOFs allowed me to measure differences in performance based on material measured. TOF1 in this case measured my bare hand, while TOF2 measured my matte black jacket sleeve. My hand, the more reflective material, made the TOF much more precise.<p>From the below code snippet and output, it's clear that the TOF ready time is the bottleneck in this case. New TOF values ready approximately every 50 ms. However, ranging does add a small delay to the loop in addition to the various serial prints of 1-2 ms.</p><img alt="TOF bottleneck" src=/files/lab3/Tof2black.png width=600><div class=note-container><button class=note-toggle><div class=note-icon><p>TOF Bottleneck Test</div></button><div class=note-content style=display:none><pre class=language-c++ data-lang=c++ style=color:#61676c;background-color:#fafafa><code class=language-c++ data-lang=c++><span>
</span><span>distanceSensor1</span><span style=color:#ed9366>.</span><span style=color:#f29718>startRanging</span><span>()</span><span style=color:#61676ccc>; 
</span><span>  distanceSensor2</span><span style=color:#ed9366>.</span><span style=color:#f29718>startRanging</span><span>()</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// int start_time, delay_time;
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// start_time = millis();
</span><span>  </span><span style=color:#fa6e32>if </span><span>(distanceSensor1</span><span style=color:#ed9366>.</span><span style=color:#f29718>checkForDataReady</span><span>())
</span><span>  {
</span><span>    </span><span style=color:#fa6e32>int</span><span> distance1 </span><span style=color:#ed9366>=</span><span> distanceSensor1</span><span style=color:#ed9366>.</span><span style=color:#f29718>getDistance</span><span>()</span><span style=color:#61676ccc>;
</span><span>    distanceSensor1</span><span style=color:#ed9366>.</span><span style=color:#f29718>clearInterrupt</span><span>()</span><span style=color:#61676ccc>;
</span><span>    distanceSensor1</span><span style=color:#ed9366>.</span><span style=color:#f29718>stopRanging</span><span>()</span><span style=color:#61676ccc>;
</span><span>    Serial</span><span style=color:#ed9366>.</span><span style=color:#f29718>print</span><span>(</span><span style=color:#86b300>"Distance1(mm): "</span><span>)</span><span style=color:#61676ccc>;
</span><span>    Serial</span><span style=color:#ed9366>.</span><span style=color:#f29718>print</span><span>(distance1)</span><span style=color:#61676ccc>;
</span><span>    Serial</span><span style=color:#ed9366>.</span><span style=color:#f29718>println</span><span>(</span><span style=color:#86b300>"   "</span><span>)</span><span style=color:#61676ccc>;
</span><span>  }
</span><span>  </span><span style=color:#fa6e32>if </span><span>(distanceSensor2</span><span style=color:#ed9366>.</span><span style=color:#f29718>checkForDataReady</span><span>())
</span><span>  {
</span><span>    </span><span style=color:#fa6e32>int</span><span> distance2 </span><span style=color:#ed9366>=</span><span> distanceSensor2</span><span style=color:#ed9366>.</span><span style=color:#f29718>getDistance</span><span>()</span><span style=color:#61676ccc>; 
</span><span>    distanceSensor2</span><span style=color:#ed9366>.</span><span style=color:#f29718>clearInterrupt</span><span>()</span><span style=color:#61676ccc>;
</span><span>    distanceSensor2</span><span style=color:#ed9366>.</span><span style=color:#f29718>stopRanging</span><span>()</span><span style=color:#61676ccc>;
</span><span>    Serial</span><span style=color:#ed9366>.</span><span style=color:#f29718>print</span><span>(</span><span style=color:#86b300>"Distance2(mm): "</span><span>)</span><span style=color:#61676ccc>;
</span><span>    Serial</span><span style=color:#ed9366>.</span><span style=color:#f29718>print</span><span>(distance2)</span><span style=color:#61676ccc>;
</span><span>    Serial</span><span style=color:#ed9366>.</span><span style=color:#f29718>println</span><span>(</span><span style=color:#86b300>"   "</span><span>)</span><span style=color:#61676ccc>;
</span><span>  }
</span><span>
</span><span>
</span><span>  </span><span style=color:#abb0b6;font-style:italic>//time delay
</span><span>  Serial</span><span style=color:#ed9366>.</span><span style=color:#f29718>print</span><span>(</span><span style=color:#86b300>"T: "</span><span>)</span><span style=color:#61676ccc>;
</span><span>  Serial</span><span style=color:#ed9366>.</span><span style=color:#f29718>print</span><span>(</span><span style=color:#f29718>millis</span><span>())</span><span style=color:#61676ccc>;
</span><span>  Serial</span><span style=color:#ed9366>.</span><span style=color:#f29718>print</span><span>(</span><span style=color:#86b300>"   "</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span>  Serial</span><span style=color:#ed9366>.</span><span style=color:#f29718>println</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span></code></pre></div></div><p>Output:</p><img alt="TOF bottleneck" src=/files/lab3/bottleneck.png width=600><p>I wrote a command <em>RECORD_TOF</em> which grabs 100 values from each TOF sensor and sends via BLE using my existing <em>GET_DATA</em> command.<div class=note-container><button class=note-toggle><div class=note-icon><p>RECORD_TOF</div></button><div class=note-content style=display:none><pre class=language-c++ data-lang=c++ style=color:#61676c;background-color:#fafafa><code class=language-c++ data-lang=c++><span style=color:#fa6e32>case</span><span> RECORD_TOF</span><span style=color:#61676ccc>:
</span><span>          tx_estring_value</span><span style=color:#ed9366>.</span><span style=color:#f29718>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>          distanceSensor1</span><span style=color:#ed9366>.</span><span style=color:#f29718>startRanging</span><span>()</span><span style=color:#61676ccc>; 
</span><span>          distanceSensor2</span><span style=color:#ed9366>.</span><span style=color:#f29718>startRanging</span><span>()</span><span style=color:#61676ccc>;
</span><span>          </span><span style=color:#f29718>digitalWrite</span><span>(blinkPin</span><span style=color:#61676ccc>,</span><span> HIGH)</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>//record
</span><span>          </span><span style=color:#fa6e32>for </span><span>(</span><span style=color:#fa6e32>int</span><span> i </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;</span><span> i </span><span style=color:#ed9366>&lt;</span><span> TOFStore</span><span style=color:#61676ccc>;</span><span> i</span><span style=color:#ed9366>++</span><span>) {
</span><span>            
</span><span>            TOFs[i][</span><span style=color:#ff8f40>0</span><span>] </span><span style=color:#ed9366>=</span><span> distanceSensor1</span><span style=color:#ed9366>.</span><span style=color:#f29718>getDistance</span><span>()</span><span style=color:#61676ccc>;
</span><span>            TOFs[i][</span><span style=color:#ff8f40>1</span><span>] </span><span style=color:#ed9366>=</span><span> distanceSensor2</span><span style=color:#ed9366>.</span><span style=color:#f29718>getDistance</span><span>()</span><span style=color:#61676ccc>;
</span><span>            TOFs[i][</span><span style=color:#ff8f40>2</span><span>] </span><span style=color:#ed9366>= </span><span style=color:#f29718>millis</span><span>()</span><span style=color:#61676ccc>;
</span><span>            </span><span style=color:#f29718>delay</span><span>(</span><span style=color:#ff8f40>50</span><span>)</span><span style=color:#61676ccc>;
</span><span>            
</span><span>          }
</span><span>          </span><span style=color:#f29718>digitalWrite</span><span>(blinkPin</span><span style=color:#61676ccc>,</span><span> LOW)</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>//stop recording
</span><span>        </span><span style=color:#fa6e32>break</span><span style=color:#61676ccc>;
</span></code></pre></div></div><p>I generated the following values with the testing setup below: <img alt="TOF6 in results" src=/files/lab3/TOF6inResults.png width=700></p><img alt="TOF6 in results" src=/files/lab3/TOF6inTest.png width=600><p>I implemented the TOF recording into my main loop via a <em>record_TOF()</em> function which is called when either of the two TOFs are ready.<div class=note-container><button class=note-toggle><div class=note-icon><p>record_TOF() V1</div></button><div class=note-content style=display:none><pre class=language-c++ data-lang=c++ style=color:#61676c;background-color:#fafafa><code class=language-c++ data-lang=c++><span>
</span><span style=color:#f29718>record_TOF</span><span>()
</span><span>{
</span><span>
</span><span>  </span><span style=color:#fa6e32>int</span><span> distance1 </span><span style=color:#ed9366>=</span><span> distanceSensor1</span><span style=color:#ed9366>.</span><span style=color:#f29718>getDistance</span><span>()</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>//Get the result of the measurement from the sensor
</span><span>  </span><span style=color:#fa6e32>int</span><span> distance2 </span><span style=color:#ed9366>=</span><span> distanceSensor2</span><span style=color:#ed9366>.</span><span style=color:#f29718>getDistance</span><span>()</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>//Get the result of the measurement from the sensor
</span><span>
</span><span>  distanceSensor1</span><span style=color:#ed9366>.</span><span style=color:#f29718>clearInterrupt</span><span>()</span><span style=color:#61676ccc>;
</span><span>  distanceSensor1</span><span style=color:#ed9366>.</span><span style=color:#f29718>stopRanging</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span>  distanceSensor2</span><span style=color:#ed9366>.</span><span style=color:#f29718>clearInterrupt</span><span>()</span><span style=color:#61676ccc>;
</span><span>  distanceSensor2</span><span style=color:#ed9366>.</span><span style=color:#f29718>stopRanging</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span>
</span><span>
</span><span>
</span><span>  TOFs[TOFStored][</span><span style=color:#ff8f40>0</span><span>] </span><span style=color:#ed9366>=</span><span> distance1</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>//tof1
</span><span>  TOFs[TOFStored][</span><span style=color:#ff8f40>1</span><span>] </span><span style=color:#ed9366>=</span><span> distance2</span><span style=color:#61676ccc>;  </span><span style=color:#abb0b6;font-style:italic>//tof2
</span><span>  TOFs[TOFStored][</span><span style=color:#ff8f40>2</span><span>] </span><span style=color:#ed9366>= </span><span style=color:#f29718>millis</span><span>()</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>//toftime
</span><span>
</span><span>  TOFStored</span><span style=color:#ed9366>++</span><span style=color:#61676ccc>;
</span><span>
</span><span>
</span><span>}
</span><span>
</span></code></pre></div></div><p>This significantly slowed IMU and TOF data from their standalone tests. The IMU recorded 3079 datapoints in 20 seconds, and the TOF recorded 86, for sample rates of 154Hz and 4.3Hz, respectively. The IMU sample rate is reasonable, but TOF appears too low to be useful -- We want about 10Hz from it. I collected the data below with a series of pitches, rolls, yaws, and oscillations in the z-axis (where TOFs point).</p><img alt=IMU src=/files/lab3/finalIMU.png width=1200><img alt=TOF src=/files/lab3/finalTOF.png width=800><p>To try and speed up execution, I created two separate lenArrx2 arrays for storing individual TOF data and their timestamps, making my <em>record_TOF()</em> look like this:<div class=note-container><button class=note-toggle><div class=note-icon><p>record_TOF() V2</div></button><div class=note-content style=display:none><pre class=language-c++ data-lang=c++ style=color:#61676c;background-color:#fafafa><code class=language-c++ data-lang=c++><span>
</span><span style=color:#f29718>record_TOF</span><span>(</span><span style=color:#fa6e32>int</span><span> i)
</span><span>{
</span><span>  </span><span style=color:#fa6e32>if</span><span>(i</span><span style=color:#ed9366>==</span><span style=color:#ff8f40>1</span><span>){
</span><span>    </span><span style=color:#fa6e32>int</span><span> distance1 </span><span style=color:#ed9366>=</span><span> distanceSensor1</span><span style=color:#ed9366>.</span><span style=color:#f29718>getDistance</span><span>()</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>//Get the result of the measurement from the sensor
</span><span>    distanceSensor1</span><span style=color:#ed9366>.</span><span style=color:#f29718>clearInterrupt</span><span>()</span><span style=color:#61676ccc>;
</span><span>    distanceSensor1</span><span style=color:#ed9366>.</span><span style=color:#f29718>stopRanging</span><span>()</span><span style=color:#61676ccc>;
</span><span>    TOF1s[TOF1Stored][</span><span style=color:#ff8f40>0</span><span>] </span><span style=color:#ed9366>=</span><span> distance1</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>//tof1
</span><span>    TOF1s[TOF1Stored][</span><span style=color:#ff8f40>1</span><span>] </span><span style=color:#ed9366>= </span><span style=color:#f29718>millis</span><span>()</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>//tof1time
</span><span>    TOF1Stored</span><span style=color:#ed9366>++</span><span style=color:#61676ccc>;
</span><span>
</span><span>  }</span><span style=color:#fa6e32>else if</span><span>(i</span><span style=color:#ed9366>==</span><span style=color:#ff8f40>2</span><span>){
</span><span>    </span><span style=color:#fa6e32>int</span><span> distance2 </span><span style=color:#ed9366>=</span><span> distanceSensor2</span><span style=color:#ed9366>.</span><span style=color:#f29718>getDistance</span><span>()</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>//Get the result of the measurement from the sensor
</span><span>    distanceSensor2</span><span style=color:#ed9366>.</span><span style=color:#f29718>clearInterrupt</span><span>()</span><span style=color:#61676ccc>;
</span><span>    distanceSensor2</span><span style=color:#ed9366>.</span><span style=color:#f29718>stopRanging</span><span>()</span><span style=color:#61676ccc>;
</span><span>    TOF2s[TOF2Stored][</span><span style=color:#ff8f40>0</span><span>] </span><span style=color:#ed9366>=</span><span> distance2</span><span style=color:#61676ccc>;  </span><span style=color:#abb0b6;font-style:italic>//tof2
</span><span>    TOF2s[TOF2Stored][</span><span style=color:#ff8f40>1</span><span>] </span><span style=color:#ed9366>= </span><span style=color:#f29718>millis</span><span>()</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>//tof2time
</span><span>    TOF2Stored</span><span style=color:#ed9366>++</span><span style=color:#61676ccc>;
</span><span>
</span><span>  }</span><span style=color:#fa6e32>else</span><span>{
</span><span>
</span><span>    Serial</span><span style=color:#ed9366>.</span><span style=color:#f29718>println</span><span>(</span><span style=color:#86b300>"bad TOF index"</span><span>)</span><span style=color:#61676ccc>;
</span><span>  }
</span><span>
</span><span>}
</span><span>
</span><span>
</span></code></pre></div></div><p>THis resulted in even less recorded TOF values -- an average of 56 per TOF per 20 seconds, or 2.8 Hz. Though this seems lower than the last test, the TOFs are likely readying at the same interval and some values were just being double counted before. Still, the sample rate of the TOFs is too low.<h2 id=collaborations><a aria-label="Anchor link for: collaborations" class=zola-anchor href=#collaborations>Collaborations</a></h2><p>I worked with <a href=https://correial.github.io/>Lucca Correia</a> and <a href=https://trevordales.github.io/>Trevor Dales</a> extensively, and referenced <a href=https://pages.github.coecis.cornell.edu/dak267/dak267.github.io/#contact>Daria's</a> and <a href=https://mavisfu.github.io/lab3.html>Mavis'</a> site for multi-TOF operation.<h1 id=next-lab-4><a aria-label="Anchor link for: next-lab-4" class=zola-anchor href=#next-lab-4>Next: <a href=/fast-robots/lab4>Lab 4</a></a></h1></section></article></main><div class=giscus></div><script -- <!-- <-- change repo src=https://utteranc.es/client.js this to your>issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async></script></div>