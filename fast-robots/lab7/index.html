<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://jack-d-long.github.io/ name=base><title>
         Lab 7
        
    </title><meta content="Lab 7" property=og:title><meta content="This is an example description" property=og:description><meta content="This is an example description" name=description><link href=/alien.png rel=icon type=image/png><link href=https://jack-d-long.github.io/fonts.css rel=stylesheet><script src=https://jack-d-long.github.io/js/codeblock.js></script><script src=https://jack-d-long.github.io/js/toc.js></script><script src=https://jack-d-long.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Jack Long" href=https://jack-d-long.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://jack-d-long.github.io/theme/light.css rel=stylesheet><link href=https://jack-d-long.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://jack-d-long.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://jack-d-long.github.io/main.css media=screen rel=stylesheet><script src=https://jack-d-long.github.io/js/mermaid.js></script><script src="https://jack-d-long.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://jack-d-long.github.io/>Jack Long</a><div class=socials><a class=social href=https://linkedin.com/in/jacklong257 rel=me> <img alt=linkedin src=https://jack-d-long.github.io/social_icons/linkedin.svg> </a><a class=social href=https://github.com/jack-d-long/ rel=me> <img alt=github src=https://jack-d-long.github.io/social_icons/github.svg> </a></div></div><nav><a href=https://jack-d-long.github.io/portfolio style=margin-left:.25em>/portfolio</a><a href=https://jack-d-long.github.io/about style=margin-left:.25em>/about</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://jack-d-long.github.io/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://jack-d-long.github.io/feather/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://jack-d-long.github.io/feather/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><main><article><div class=title><div class=page-header>Lab 7<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2025-03-17</time></div></div><div class=toc-container><h1 class=toc-title>Table of Contents</h1><ul class=toc-list><li><a href=https://jack-d-long.github.io/fast-robots/lab7/#previous-lab-6>Previous: Lab 6</a> <ul><li><a href=https://jack-d-long.github.io/fast-robots/lab7/#lab-tasks>Lab Tasks</a></li><ul><li><a href=https://jack-d-long.github.io/fast-robots/lab7/#system-identification>System Identification</a><li><a href=https://jack-d-long.github.io/fast-robots/lab7/#kalman-filter-simulation>Kalman Filter Simulation</a><li><a href=https://jack-d-long.github.io/fast-robots/lab7/#onboard-kalman-filter>Onboard Kalman Filter</a></ul><li><a href=https://jack-d-long.github.io/fast-robots/lab7/#collaborations>Collaborations</a></ul><li><a href=https://jack-d-long.github.io/fast-robots/lab7/#next-lab-8>Next: Lab 8</a></ul></div><section class=body><h1 id=previous-lab-6><a aria-label="Anchor link for: previous-lab-6" class=zola-anchor href=#previous-lab-6>Previous: <a href=/fast-robots/lab6>Lab 6</a></a></h1><h2 id=lab-tasks><a aria-label="Anchor link for: lab-tasks" class=zola-anchor href=#lab-tasks>Lab Tasks</a></h2><h3 id=system-identification><a aria-label="Anchor link for: system-identification" class=zola-anchor href=#system-identification>System Identification</a></h3><p>If we approximate the open-loop robot system as first-order with respect to velocity, using Newton's second law to write<p>$$ F = ma = m\ddot{x} $$<p>with dynamics<p>$$ \ddot{x} = \frac{d}{m} \dot{x} + \frac{u}{m} $$<p>where $d$ and $m$ are lumped-parameter terms to roughly describe the drag (incorporating resistance from the air, ground, and motor dynamics) and intertia (incorporating mostly car mass, but also motor dynamics).<p>Choosing a state<p>$$ x = \begin{bmatrix} x \cr \dot{x} \end{bmatrix} $$<p>we can then describe the open-loop system in state-space form as $$ A = \begin{bmatrix}0 & 1 \cr 0 & -d/m\end{bmatrix} \text{ } B = \begin{bmatrix}0 \cr 1/m\end{bmatrix}. $$<p>We're only directly measuring the TOF data $x$, so it makes sense for our state-space system to output exclusively the position of the system (relative to a wall). In other words, with transition and output matrices<p>$$ C = \begin{bmatrix} -1 \cr 0 \end{bmatrix} \text{ } D = \begin{bmatrix}0 \cr 0\end{bmatrix} $$<p>With a PWM input of 80 (around the center of my applied range in <a href=/fast-robots/lab5>Lab 5</a>), I measured the following open-loop data and applied a low-pass-filter with $\alpha$ = 1 Hz:</p><img alt=sysID_v2_pwm80 src=/files/lab7/sysID_v2_pwm80.png width=800><p>I then applied an exponential fit to the velocity data and marked the steady-state and 90% rise time points.</p><img alt="curve fit" src=/files/lab7/sysID_v2_curvefit.png width=800><p>with a steady-state velocity of -2091.5 mm/s $\approx$ -2.09 m/s, and 90% rise time of 2.55 s, and setting u = 1 N (unit input), we have<p>$$ d = \frac{1 N}{2.09 m/s} = .478 kg/s $$<p>as our drag parameter, and<p>$$ m = \frac{.478 kg/s * 2.55 s}{ln(.1)} = .529 kg $$<p>as our momentum parameter, leading to<p>$$ A=\begin{bmatrix}0 & 1 \cr 0 & -0.903\end{bmatrix}<br> $$<p>and $$ B=\begin{bmatrix}0 \cr 1.75\end{bmatrix} $$<p><strong>Note</strong>: looking back on this, I used too low a speed compared to my maximum for a 90% rise time -- I should've used something like 60%. However, my filter performed well with the above values, so I decided to proceed without going back and modifying A and B.<h3 id=kalman-filter-simulation><a aria-label="Anchor link for: kalman-filter-simulation" class=zola-anchor href=#kalman-filter-simulation>Kalman Filter Simulation</a></h3><p>I get new motor inputs (not necessarily new TOF values ) every 20 ms, so I used that as my Kalman filter timestep.<p>to get an initial estimate for variances, I used<p>$$ \sigma_1 = \sigma_2 = \sqrt{\frac{100}{dt}} $$ for the process uncertainty, based on the sample time $dt$ that the system has to deviate from the predicted state, and $$ \sigma_3 = \sqrt{\frac{100}{dx}} $$ for the sensor uncertainty, based on the sensor variance $dx$. In a static test at 2000 mm from a white wall, I measured a variance $dx = 80.9$ mm.<p>Substituting,<p>$$ \sigma_1 = \sigma_2 = 70.7 $$ and $$ \sigma_3 = 35.1. $$<p>I then discretized my matrices according to the above $dt = .02$ s and used the provided <code>kf()</code> to filter my data in Python.<pre class=language-python data-lang=python style=color:#61676c;background-color:#fafafa><code class=language-python data-lang=python><span>
</span><span>Ad </span><span style=color:#ed9366>= </span><span>np</span><span style=color:#ed9366>.</span><span style=color:#f29718>eye</span><span>(</span><span style=color:#ff8f40>2</span><span>) </span><span style=color:#ed9366>+ </span><span>dt </span><span style=color:#ed9366>* </span><span>A
</span><span>Bd </span><span style=color:#ed9366>= </span><span>dt </span><span style=color:#ed9366>* </span><span>B
</span><span>
</span><span>x </span><span style=color:#ed9366>= </span><span>np</span><span style=color:#ed9366>.</span><span style=color:#f29718>array</span><span>([[</span><span style=color:#ed9366>-</span><span>tof[</span><span style=color:#ff8f40>0</span><span>]]</span><span style=color:#61676ccc>, </span><span>[</span><span style=color:#ff8f40>0</span><span>]])  </span><span style=color:#abb0b6;font-style:italic># TOF from collected data
</span><span>
</span><span>Sigma_u </span><span style=color:#ed9366>= </span><span>np</span><span style=color:#ed9366>.</span><span style=color:#f29718>array</span><span>([[sigma_1</span><span style=color:#ed9366>**</span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>]</span><span style=color:#61676ccc>, </span><span>[</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span>sigma_2</span><span style=color:#ed9366>**</span><span style=color:#ff8f40>2</span><span>]]) </span><span style=color:#abb0b6;font-style:italic># process noise
</span><span>Sigma_z </span><span style=color:#ed9366>= </span><span>np</span><span style=color:#ed9366>.</span><span style=color:#f29718>array</span><span>([[sigma_3</span><span style=color:#ed9366>**</span><span style=color:#ff8f40>2</span><span>]]) </span><span style=color:#abb0b6;font-style:italic># sensor noise
</span><span>
</span><span style=color:#ff8f40>...
</span><span>
</span><span>
</span><span style=color:#fa6e32>def </span><span style=color:#f29718>kf</span><span>(</span><span style=color:#ff8f40>mu</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>sigma</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>u</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>y</span><span>):
</span><span>    mu_p </span><span style=color:#ed9366>= </span><span>Ad</span><span style=color:#ed9366>.</span><span style=color:#f29718>dot</span><span>(mu) </span><span style=color:#ed9366>+ </span><span>Bd</span><span style=color:#ed9366>.</span><span style=color:#f29718>dot</span><span>(u)
</span><span>    
</span><span>    
</span><span>    sigma_p </span><span style=color:#ed9366>= </span><span>Ad</span><span style=color:#ed9366>.</span><span style=color:#f29718>dot</span><span>(sigma</span><span style=color:#ed9366>.</span><span style=color:#f29718>dot</span><span>(Ad</span><span style=color:#ed9366>.</span><span style=color:#f29718>transpose</span><span>())) </span><span style=color:#ed9366>+ </span><span>Sigma_u
</span><span>    
</span><span>    sigma_m </span><span style=color:#ed9366>= </span><span>C</span><span style=color:#ed9366>.</span><span style=color:#f29718>dot</span><span>(sigma_p</span><span style=color:#ed9366>.</span><span style=color:#f29718>dot</span><span>(C</span><span style=color:#ed9366>.</span><span style=color:#f29718>transpose</span><span>())) </span><span style=color:#ed9366>+ </span><span>Sigma_z
</span><span>    
</span><span>    kkf_gain </span><span style=color:#ed9366>= </span><span>sigma_p</span><span style=color:#ed9366>.</span><span style=color:#f29718>dot</span><span>(C</span><span style=color:#ed9366>.</span><span style=color:#f29718>transpose</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f29718>dot</span><span>(np</span><span style=color:#ed9366>.</span><span>linalg</span><span style=color:#ed9366>.</span><span style=color:#f29718>inv</span><span>(sigma_m)))
</span><span>    
</span><span>    y_m </span><span style=color:#ed9366>= </span><span>y </span><span style=color:#ed9366>- </span><span>C</span><span style=color:#ed9366>.</span><span style=color:#f29718>dot</span><span>(mu_p)
</span><span>    
</span><span>    mu </span><span style=color:#ed9366>= </span><span>mu_p </span><span style=color:#ed9366>+ </span><span>kkf_gain</span><span style=color:#ed9366>.</span><span style=color:#f29718>dot</span><span>(y_m)
</span><span>    
</span><span>    sigma </span><span style=color:#ed9366>= </span><span>(np</span><span style=color:#ed9366>.</span><span style=color:#f29718>eye</span><span>(</span><span style=color:#ff8f40>2</span><span>) </span><span style=color:#ed9366>- </span><span>kkf_gain</span><span style=color:#ed9366>.</span><span style=color:#f29718>dot</span><span>(C))</span><span style=color:#ed9366>.</span><span style=color:#f29718>dot</span><span>(sigma_p)
</span><span>    
</span><span>
</span><span>    </span><span style=color:#fa6e32>return </span><span>mu, sigma
</span><span>
</span><span>
</span></code></pre><p>With my process and sensor noise of $\sigma_1 = \sigma_2$ = 70.7 and $\sigma_3$ = 35.1, my filtered data looked like this:</p><img alt="KF 1" src=/files/lab7/kalmanfirstguessfrfr.png width=800><p>This is a bit tight to the raw data for my taste, Decreasing process noise (i.e. if I become more certain about the model I think my robot operates on, and less certain of my sensor data relative to the model), I get the following:</p><img alt="KF 2" src=/files/lab7/kf_lowprocess_highsensor.png width=800><p>After tweaking the covariances some more, I was able to get the following filtered data, which appears to track the real distance pretty well:</p><img alt="KF 3" src=/files/lab7/kf_okiedokie.png width=800><h3 id=onboard-kalman-filter><a aria-label="Anchor link for: onboard-kalman-filter" class=zola-anchor href=#onboard-kalman-filter>Onboard Kalman Filter</a></h3><p>To implement the Kalman filter on my robot, I wrote a function <code>kalman_filter()</code> which uses the <a href=https://github.com/tomstewart89/BasicLinearAlgebra/blob/master/BasicLinearAlgebra.h>BasicLinearAlgebra</a> library for matrix math.<pre class=language-c++ data-lang=c++ style=color:#61676c;background-color:#fafafa><code class=language-c++ data-lang=c++><span>
</span><span style=color:#abb0b6;font-style:italic>// state, uncertainties, measured val
</span><span>
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>KF_vars </span><span>{
</span><span>    Matrix&lt;</span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>,</span><span style=color:#ff8f40>1</span><span>> mu </span><span style=color:#61676ccc>;
</span><span>    Matrix&lt;</span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>,</span><span style=color:#ff8f40>2</span><span>> sigma</span><span style=color:#61676ccc>;
</span><span>}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#ed9366>... 
</span><span>
</span><span>
</span><span>KF_vars </span><span style=color:#f29718>kalman_filter</span><span>(Matrix&lt;</span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>,</span><span style=color:#ff8f40>1</span><span>> </span><span style=color:#ff8f40>mu</span><span style=color:#61676ccc>,</span><span> Matrix&lt;</span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>2</span><span>> </span><span style=color:#ff8f40>sigma</span><span style=color:#61676ccc>,</span><span> Matrix&lt;</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>,</span><span style=color:#ff8f40>1</span><span>>  </span><span style=color:#ff8f40>u</span><span style=color:#61676ccc>,</span><span> Matrix&lt;</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>,</span><span style=color:#ff8f40>1</span><span>>  </span><span style=color:#ff8f40>y</span><span>){
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// PREDICT
</span><span>
</span><span>    Matrix&lt;</span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>,</span><span style=color:#ff8f40>1</span><span>> mu_p </span><span style=color:#ed9366>=</span><span> Ad </span><span style=color:#ed9366>* </span><span>(mu) </span><span style=color:#ed9366>+</span><span> Bd </span><span style=color:#ed9366>* </span><span>(u)</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    Matrix&lt;</span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>,</span><span style=color:#ff8f40>2</span><span>> sigma_p </span><span style=color:#ed9366>=</span><span> Ad </span><span style=color:#ed9366>*</span><span> sigma </span><span style=color:#ed9366>* ~</span><span>Ad </span><span style=color:#ed9366>+</span><span> sigma_u</span><span style=color:#61676ccc>;   
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// UPDATE
</span><span>
</span><span>    Matrix&lt;</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>,</span><span style=color:#ff8f40>1</span><span>> sigma_m </span><span style=color:#ed9366>=  </span><span>(C </span><span style=color:#ed9366>*</span><span> sigma_p </span><span style=color:#ed9366>* ~</span><span>C) </span><span style=color:#ed9366>+</span><span> sigma_z</span><span style=color:#61676ccc>;
</span><span>
</span><span>    Matrix&lt;</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>,</span><span style=color:#ff8f40>1</span><span>> sigma_m_inv </span><span style=color:#ed9366>=</span><span> sigma_m</span><span style=color:#61676ccc>;
</span><span>
</span><span>    Matrix&lt;</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>,</span><span style=color:#ff8f40>1</span><span>> sigma_m_inv </span><span style=color:#ed9366>= </span><span>{</span><span style=color:#ff8f40>1</span><span style=color:#ed9366>/</span><span style=color:#f29718>sigma_m</span><span>(</span><span style=color:#ff8f40>0</span><span>)}</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// use scalar inverse instead
</span><span>
</span><span>    Matrix&lt;</span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>,</span><span style=color:#ff8f40>1</span><span>> kkf_gain </span><span style=color:#ed9366>=</span><span>  sigma_p </span><span style=color:#ed9366>* ~</span><span>C </span><span style=color:#ed9366>*</span><span> sigma_m_inv </span><span style=color:#61676ccc>; 
</span><span>
</span><span>    Matrix&lt;</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>,</span><span style=color:#ff8f40>1</span><span>> y_m </span><span style=color:#ed9366>=</span><span>   y </span><span style=color:#ed9366>-  </span><span>( C </span><span style=color:#ed9366>*</span><span> mu_p)</span><span style=color:#61676ccc>;
</span><span>
</span><span>
</span><span>    Matrix&lt;</span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>,</span><span style=color:#ff8f40>1</span><span>> mu_out </span><span style=color:#ed9366>=</span><span> mu_p </span><span style=color:#ed9366>+</span><span> kkf_gain </span><span style=color:#ed9366>*</span><span> y_m </span><span style=color:#61676ccc>;
</span><span>    
</span><span>    Matrix&lt;</span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>,</span><span style=color:#ff8f40>2</span><span>> sigma_out </span><span style=color:#ed9366>=</span><span> I  </span><span style=color:#ed9366>-</span><span> kkf_gain </span><span style=color:#ed9366>*</span><span> C </span><span style=color:#ed9366>*</span><span> sigma_p </span><span style=color:#61676ccc>; 
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// FORMAT FOR OUTPUT
</span><span>
</span><span>    KF_vars out</span><span style=color:#61676ccc>;
</span><span>
</span><span>    out</span><span style=color:#ed9366>.</span><span>mu </span><span style=color:#ed9366>=</span><span> mu_out</span><span style=color:#61676ccc>;
</span><span>    out</span><span style=color:#ed9366>.</span><span>sigma </span><span style=color:#ed9366>=</span><span> sigma_out</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>return</span><span> out</span><span style=color:#61676ccc>;
</span><span>  
</span><span>}
</span><span>
</span></code></pre><p>I didn't use the BasicLinearAlgebra <code>Inverse()</code> function as I found it didn't invert the 1x1 <code>sigma_m</code> correctly. It was pretty simple to just take the scalar inverse, though.<p>I did some testing on just the TOF (no motor input) and found really promising results with the above uncertanties: <img alt="KF 4" src=/files/lab7/kf_real_nice.png width=800><p>As a sanity check, I tried modifying my gains in a similar manner to the above, and got the following responses: <img alt="KF 4" src=/files/lab7/kf_less_nice.png width=850> <img alt="KF 4" src=/files/lab7/kf_tight.png width=800><p>Although there are a few differences between the measured and predicted Kalman filter data, they have similar enough characteristics that I don't think the controller will have any trouble.<p>This one was a bit heavy on the P gain, but showcases the smoothness of the filter well:</p><iframe allowfullscreen height=500 src=https://youtube.com/embed/ThPhT8SlPv0 width=800></iframe><img alt="KF 4" src=/files/lab7/kf-first-go.png width=800><p>After some tuning, I got the following response:</p><iframe allowfullscreen height=500 src=https://youtube.com/embed/uIMHTydcZ9w width=800></iframe><img alt="KF 6" src=/files/lab7/kffinal.png width=800><p><strong>Note</strong>: Fix of the initial TOF zero values coming soon!<h2 id=collaborations><a aria-label="Anchor link for: collaborations" class=zola-anchor href=#collaborations>Collaborations</a></h2><p>I worked with <a href=https://correial.github.io/>Lucca Correia</a> and <a href=https://trevordales.github.io/>Trevor Dales</a> extensively. I used ChatGPT to help with curve fitting and generating nice plots and looked at <a href=https://fast.synthghost.com/lab-5-linear-pid-control/>Stephan's</a> site for some rationale on initial estimates.<h1 id=next-lab-8><a aria-label="Anchor link for: next-lab-8" class=zola-anchor href=#next-lab-8>Next: <a href=/fast-robots/lab8>Lab 8</a></a></h1></section></article></main><div class=giscus></div><script -- <!-- <-- change repo src=https://utteranc.es/client.js this to your>issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async></script></div>